key: DefineProcess
description: >
  Transform a human-readable process description into a validated HFSM
  configuration. Collect user input, generate an initial config with AI,
  validate it structurally and semantically, refine iteratively until
  valid, then serialize to YAML.
outcome: >
  Validated FsmStateConfig serialized as a YAML file, passing all
  structural validation rules and semantic coherence checks
actors: [User, AiModel, Validator]
object: FsmStateConfig

transitions:
  - ["", "*", "GetUserInput"]
  - ["GetUserInput", "inputReady", "GenerateProcessConfig"]
  - ["GetUserInput", "noInput", ""]
  - ["GenerateProcessConfig", "configValid", "SerializeConfig"]
  - ["GenerateProcessConfig", "generationFailed", ""]
  - ["SerializeConfig", "configSerialized", ""]

states:

  # ── Phase 1: Collect input ─────────────────────────────────────────

  - key: GetUserInput
    description: >
      Collect the human-readable process description from user input.
      Accept a file path, stdin pipe, or interactive prompt.
      Validate that the input is non-empty text.
    outcome: Process description text loaded and ready for HFSM generation
    actors: [User]
    object: Process description text
    events:
      inputReady: >
        When description text is successfully loaded and is non-empty
      noInput: >
        When no description is provided, the file is missing, or the user cancels

  # ── Phase 2: Generate, validate, refine (iterative) ────────────────

  - key: GenerateProcessConfig
    description: >
      Generate an initial HFSM configuration from the user's description
      using AI, then iteratively validate and refine it until it passes
      both structural validation and semantic coherence evaluation
    outcome: >
      FsmStateConfig that passes all structural rules (L1-S9) with zero
      errors and zero warnings, and passes AI semantic coherence evaluation
      (M4, M8, M9) with no incoherencies detected
    actors: [AiModel, Validator]
    object: FsmStateConfig
    events:
      configValid: >
        When the configuration passes all structural validation rules
        and semantic coherence evaluation with no issues
      generationFailed: >
        When maximum refinement iterations are exceeded without producing
        a fully valid configuration
    transitions:
      - ["", "*", "GenerateInitialConfig"]
      - ["GenerateInitialConfig", "configGenerated", "ValidateProcessConfig"]
      - ["ValidateProcessConfig", "configValid", ""]
      - ["ValidateProcessConfig", "validationFailed", "RefineProcessConfig"]
      - ["RefineProcessConfig", "configRefined", "ValidateProcessConfig"]
      - ["RefineProcessConfig", "generationFailed", ""]
    states:

      - key: GenerateInitialConfig
        description: >
          Use AI (generateObject with Zod schema) to transform the user's
          process description into an initial FsmStateConfig. The system
          prompt includes the 7-step transformation methodology from
          agent-rules/instructions.md: decompose into steps, build
          hierarchy, identify branches, identify cycles, map events
          and transitions, fill gaps, semantic review.
        outcome: >
          Initial FsmStateConfig generated from the description,
          structurally plausible but not yet validated
        actors: [AiModel]
        object: FsmStateConfig
        events:
          configGenerated: >
            When AI successfully produces an initial HFSM configuration
            conforming to the Zod schema

      - key: ValidateProcessConfig
        description: >
          Run two-phase validation on the current configuration.
          Phase 1 — structural: call validate() from @statewalker/fsm-validator
          checking all lexical (L1-L8), structural (S1-S9), and mechanical
          semantic rules (M1-M7). Phase 2 — semantic coherence: send
          the config together with the structural validation report to AI
          for evaluation of goal alignment (M9), event-state consistency
          (M8), and convergent transition compatibility (M4). Combine
          results from both phases into a single validation report.
        outcome: >
          Complete validation report combining structural issues and
          semantic incoherencies, or confirmation that no issues exist
        actors: [Validator, AiModel]
        object: Validation report
        events:
          configValid: >
            When structural validation returns zero errors and zero
            warnings, and AI semantic evaluation detects no incoherencies
          validationFailed: >
            When structural validation returns errors or warnings, or AI
            semantic evaluation detects incoherencies in goals, events,
            or parent-child alignment

      - key: RefineProcessConfig
        description: >
          Send the current configuration along with the complete
          validation report (structural issues + semantic incoherencies)
          to AI for targeted refinement. AI fixes reported issues while
          preserving the overall process structure and semantics.
          Track the iteration count against the configured maximum.
        outcome: >
          Refined FsmStateConfig that addresses all reported validation
          issues from the previous iteration
        actors: [AiModel]
        object: FsmStateConfig
        events:
          configRefined: >
            When AI produces a refined configuration addressing the
            reported structural and semantic issues
          generationFailed: >
            When the refinement iteration count exceeds the maximum
            limit without resolving all issues

  # ── Phase 3: Serialize output ──────────────────────────────────────

  - key: SerializeConfig
    description: >
      Serialize the validated FsmStateConfig to YAML format and write
      to the specified output file path. Include all metadata fields
      (description, outcome, events, actors, object).
    outcome: YAML file written to the output path
    actors: [User]
    object: YAML file
    events:
      configSerialized: >
        When YAML file is successfully written to the output path
